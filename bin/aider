#!/usr/bin/env bash

# Other available models:
# - "openai/gpt-4o"
# - "deepseek/deepseek-r1:free"
# - "anthropic/claude-opus-4"
DEFAULT_MODEL="anthropic/claude-sonnet-4"

DEFAULT_API_KEY="$(secret-tool lookup service openrouter)"

AIDER_MODEL=${AIDER_MODEL:-"$DEFAULT_MODEL"}
OPENROUTER_API_KEY=${OPENROUTER_API_KEY:-"$DEFAULT_API_KEY"}

if [[ -z "$OPENROUTER_API_KEY" ]]; then
  echo "Error: OPENROUTER_API_KEY is empty or not set"
  exit 1
fi

export OPENROUTER_API_KEY

echo "Using model: $AIDER_MODEL"

SCRIPT_PATH=$(realpath "$0")
SCRIPT_DIR=$(dirname "$SCRIPT_PATH")

# Find aider in PATH directories, excluding the script's own directory
AIDER_BIN=""
IFS=':' read -ra PATH_DIRS <<< "$PATH"
for dir in "${PATH_DIRS[@]}"; do
  # Skip the script's own directory to avoid recursion
  if [[ "$dir" == "$SCRIPT_DIR" ]]; then
    continue
  fi
  # Check if an executable aider exists in this directory
  potential_aider="$dir/aider"
  if [[ -x "$potential_aider" && "$potential_aider" != "$SCRIPT_PATH" ]]; then
    AIDER_BIN="$potential_aider"
    break
  fi
done

if [[ -z "$AIDER_BIN" ]]; then
  echo "Error: Could not find actual aider executable"
  exit 1
fi

"$AIDER_BIN" \
  --config $HOME/.config/aider.yml \
  --model "openrouter/$AIDER_MODEL" \
  "$@"
